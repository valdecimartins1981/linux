---
- name: Configure rsyslog + auditd forwarding **and** set critical audit rules
  hosts: all
  become: true

  vars_prompt:
    - name: "logstash_host"
      prompt: "Enter the Logstash host IP or FQDN"
      private: no
      default: "172.16.102.241"

    - name: "logstash_port"
      prompt: "Enter the Logstash TCP port (only numbers, e.g. 1514)"
      private: no
      default: 1514

  vars:
    # ===== File locations (override perâ€‘distro if necessÃ¡rio) =====
    rsyslog_conf_path: "/etc/rsyslog.d/60-logstash.conf"
    audit_syslog_plugin_conf: "/etc/audisp/plugins.d/syslog.conf"
    audit_rules_file: "/etc/audit/rules.d/60-critical.rules"

  tasks:
    ###################################################################
    # Pacotes necessÃ¡rios
    ###################################################################
    - name: Ensure rsyslog + audit packages are present
      package:
        name: "{{ item }}"
        state: present
      loop:
        - rsyslog
        - audispd-plugins   # audisp-syslog provider
        - audit             # auditd & augenrules

    ###################################################################
    # rsyslog  â†’  Logstash
    ###################################################################
    - name: Configure rsyslog to forward *all* logs via TCP to Logstash
      copy:
        dest: "{{ rsyslog_conf_path }}"
        owner: root
        group: root
        mode: "0644"
        content: |
          # File managed by Ansible â€“ DO NOT EDIT MANUALLY
          *.* @@{{ logstash_host }}:{{ logstash_port }}
      notify: Restart rsyslog

    ###################################################################
    # auditd  â†’  syslog (audisp-syslog)
    ###################################################################
    - name: Enable audispâ€‘syslog plugin so auditd mirrors events to syslog
      lineinfile:
        path: "{{ audit_syslog_plugin_conf }}"
        regexp: '^\s*active\s*=.*'
        line: 'active = yes'
        backrefs: yes
        owner: root
        group: root
        mode: "0644"
        backup: yes
      notify:
        - Restart auditd
        - Restart rsyslog

    - name: Ensure dispatcher is set in auditd.conf (needed for audispd)
      lineinfile:
        path: "/etc/audit/auditd.conf"
        regexp: '^dispatcher\s*='
        line: 'dispatcher = /sbin/audispd'
        backup: yes
      notify: Restart auditd

    ###################################################################
    # ðŸ’¥ CRITICAL AUDIT RULES (shutdown, passwd/shadow/sudoers, apt/yum/dnf) ðŸ’¥
    ###################################################################
    - name: Deploy critical audit rules
      copy:
        dest: "{{ audit_rules_file }}"
        owner: root
        group: root
        mode: "0640"
        content: |
          ## Managed by Ansible â€“ Critical security events
          # -----------------------------------------------
          # System shutdown / reboot / poweroff / halt
          -a always,exit -F arch=b64 -S reboot -F auid>=1000 -F auid!=4294967295 -k system_shutdown
          -a always,exit -F arch=b32 -S reboot -F auid>=1000 -F auid!=4294967295 -k system_shutdown

          # Credential & privilege files modifications
          -w /etc/passwd    -p wa -k identity
          -w /etc/shadow    -p wa -k identity
          -w /etc/group     -p wa -k identity
          -w /etc/gshadow   -p wa -k identity
          -w /etc/sudoers   -p wa -k privileged-passwd
          -w /etc/sudoers.d -p wa -k privileged-passwd

          # Package management audit (APT, YUM, DNF)
          -w /usr/bin/apt       -p x -k package-manager
          -w /usr/bin/apt-get  -p x -k package-manager
          -w /usr/bin/yum      -p x -k package-manager
          -w /usr/bin/dnf      -p x -k package-manager

      notify:
        - Reload audit rules

    ###################################################################
    # Garantir serviÃ§os ativos
    ###################################################################
    - name: Ensure rsyslog & auditd services are enabled and running
      service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - rsyslog
        - auditd

  #####################################################################
  # Handlers
  #####################################################################
  handlers:
    - name: Restart rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Restart auditd
      service:
        name: auditd
        state: restarted

    - name: Reload audit rules (augenrules â†’ auditd)
      command: augenrules --load
      changed_when: true
      notify: Restart auditd
